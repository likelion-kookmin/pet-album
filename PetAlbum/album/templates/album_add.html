<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/css/common.css">
  <link rel="stylesheet" href="../static/css/album_add.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <title>Edit Album</title>
</head>
<body>
  <div class="wrapper">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarScroll">
          <ul class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll">
            <li class="nav-item dropdown">
              <a class="navbar-brand dropdown-toggle" href="#" id="navbarScrollingDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="../static/pet_thumbnail.jpg" alt="" class="pet__image">user01
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarScrollingDropdown">
                <li><a class="dropdown-item" href="#">user02</a></li>
                <li><a class="dropdown-item" href="#">user03</a></li>
              </ul>
            </li>
          </ul>
          <div class="form-check-inline">
            <label class="form-check-label text-white" for="showPublic">
              전체 공개
            </label>
            <input class="form-check-input" type="radio" name="showType" id="showPublic" checked>
          </div>
          <div class="form-check-inline">
            <label class="form-check-label text-white" for="showPrivate">
              전체 비공개
            </label>
            <input class="form-check-input" type="radio" name="showType" id="showPrivate">
          </div>
          <button class="save-button" type="button">앨범 저장하기</button>
        </div>
      </div>
    </nav>
    <div class="">
      <aside class="aside-container">
        <span class="aside__title">정렬</span>
        <div class="form-check-inline">
          <label class="form-check-label" for="newest">
            최신순
          </label>
          <input class="form-check-input" type="radio" name="sorting" id="newest">
        </div>
        <div class="form-check-inline">
          <label class="form-check-label" for="oldest">
            오래된순
          </label>
          <input class="form-check-input" type="radio" name="sorting" id="oldest" checked>
        </div>
        <div class="list-container">
          <ol class="image-list">
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample01.jpg" alt="" class="image-thumbnail">
            </li>
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample02.jpg" alt="" class="image-thumbnail">
            </li>
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample03.jpg" alt="" class="image-thumbnail">
            </li>
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample01.jpg" alt="" class="image-thumbnail">
            </li>
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample02.jpg" alt="" class="image-thumbnail">
            </li>
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample03.jpg" alt="" class="image-thumbnail">
            </li>
            <li class="image-item" onclick=showDetail()>
              <img src="../static/sample02.jpg" alt="" class="image-thumbnail">
            </li>
          </ol>
          <button onclick=showUpload() class="upload-button">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
      </aside>
      <div class="detail-container">
        <div class="moment-info hide" id="detailPage">
          <input type="text" class="form-control" id="datePicker">
          <div class="moment-container">
            <img src="../static/sample01.jpg" class="moment__image"></img>
            <button class="secret-button">
              <img src="../static/lock.svg">
            </button>
          </div>
          <input type="text" class="form-control" placeholder="문구">
          <div class="button-container">
            <button class="delete-button" type="button">삭제하기</button>
            <button class="edit-button" type="button">사진 변경</button>
          </div>
        </div>
        <div class="upload-info" id="uploadPage">
          <form name="uploadForm" id="uploadForm" enctype="multipart/form-data" method="post">
              <div id="dropZone" class="dropbox">
                  <div id="fileDragDesc">
                    <i class="bi bi-plus-lg"></i>
                    <div>Drag and drop to upload</div>
                    <div></div>
                    <p>(up to 10MB)<br>PNG, JPEG are supported</p>
                  </div>
                  <table id="fileListTable" class="upload-table">
                      <tbody id="fileTableTbody">
                      </tbody>
                  </table>
              </div>
          </form>
          <div class="upload-btn-wrapper hide" id="uploadButton">
            <label for="input_file" class="upload-btn"></label>
            <input type="file" id="input_file" multiple="multiple"/>
          </div>
          <input type="button" onclick="uploadFile(); return false;" class="upload-submit" value="파일 업로드">
        </div>
      </div>
    </div>
  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript">
  $(document).ready(function() {
    $("#input_file").bind('change', function() {
      selectFile(this.files);
      //this.files[0].size gets the size of your file.
      //alert(this.files[0].size);
    });
  });

  var fileIndex = 0; // 파일 리스트 번호
  var totalFileSize = 0; // 등록할 전체 파일 사이즈
  var fileList = new Array(); // 파일 리스트
  var fileSizeList = new Array(); // 파일 사이즈 리스트
  var uploadSize = 10; // 등록 가능한 파일 사이즈 MB
  var maxUploadSize = 500; // 등록 가능한 총 파일 사이즈 MB

  $(function() {
      fileDropDown(); // 파일 드롭 다운
  });

  // 파일 드롭 다운
  function fileDropDown() {
    var dropZone = $("#dropZone"); //Drag기능 
    dropZone.on('dragenter', function(e) {
      e.stopPropagation();
      e.preventDefault();
      dropZone.css('background-color', '#E3F2FC'); // 드롭다운 영역 css
    });
    dropZone.on('dragleave', function(e) {
      e.stopPropagation();
      e.preventDefault();
      dropZone.css('background-color', '#D2D2D2'); // 드롭다운 영역 css
    });
    dropZone.on('dragover', function(e) {
      e.stopPropagation();
      e.preventDefault();
      dropZone.css('background-color', '#E3F2FC'); // 드롭다운 영역 css
    });
    dropZone.on('drop', function(e) {
      e.preventDefault();
      dropZone.css('background-color', '#D2D2D2'); // 드롭다운 영역 css

      var files = e.originalEvent.dataTransfer.files;
      if (files != null) {
          if (files.length < 1) {
              console.log("폴더 업로드 불가"); /* alert("폴더 업로드 불가"); */
              return;
          } else {
              selectFile(files)
          }
      } else {
          alert("ERROR");
      }
    });
  }

  // 파일 선택시
  function selectFile(fileObject) {
    var files = null;

    if (fileObject != null) {
        files = fileObject; // 파일 Drag 이용하여 등록시
    } else {
        files = $('#multipaartFileList_' + fileIndex)[0].files; // 직접 파일 등록시
    }

    // 다중파일 등록
    if (files != null) {
        
      if (files != null && files.length > 0) {
          $("#fileDragDesc").hide(); 
          $("fileListTable").show();
      } else {
          $("#fileDragDesc").show(); 
          $("fileListTable").hide();
      }
      
      for (var i = 0; i < files.length; i++) {
        var fileName = files[i].name; // 파일 이름
        var fileNameArr = fileName.split("\.");
        
        var ext = fileNameArr[fileNameArr.length - 1]; // 확장자
        
        var fileSize = files[i].size; // 파일 사이즈(단위 :byte)
        console.log("fileSize="+fileSize);
        if (fileSize <= 0) {
            console.log("0kb file return");
            return;
        }
        
        var fileSizeKb = fileSize / 1024; // 파일 사이즈(단위 :kb)
        var fileSizeMb = fileSizeKb / 1024;    // 파일 사이즈(단위 :Mb)
        
        var fileSizeStr = "";
        if ((1024*1024) <= fileSize) {    // 파일 용량이 1메가 이상인 경우 
          console.log("fileSizeMb="+fileSizeMb.toFixed(2));
          fileSizeStr = fileSizeMb.toFixed(2) + " Mb";
        } else if ((1024) <= fileSize) {
          console.log("fileSizeKb="+parseInt(fileSizeKb));
          fileSizeStr = parseInt(fileSizeKb) + " kb";
        } else {
          console.log("fileSize="+parseInt(fileSize));
          fileSizeStr = parseInt(fileSize) + " byte";
        }

        /* if ($.inArray(ext, [ 'exe', 'bat', 'sh', 'java', 'jsp', 'html', 'js', 'css', 'xml' ]) >= 0) {
          // 확장자 체크
          alert("등록 불가 확장자");
          break; */
        if ($.inArray(ext, [ 'hwp', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'png', 'pdf', 'jpg', 'jpeg', 'gif', 'zip' ]) <= 0) {
          // 확장자 체크
          /* alert("등록이 불가능한 파일 입니다.");
          break; */
          alert("등록이 불가능한 파일 입니다.("+fileName+")");
        } else if (fileSizeMb > uploadSize) {
          // 파일 사이즈 체크
          alert("용량 초과\n업로드 가능 용량 : " + uploadSize + " MB");
          break;
        } else {
          totalFileSize += fileSizeMb; // 전체 파일 사이즈 
          fileList[fileIndex] = files[i]; // 파일 배열에 넣기
          fileSizeList[fileIndex] = fileSizeMb; // 파일 사이즈 배열에 넣기

          addFileList(fileIndex, fileName, fileSizeStr); // 업로드 파일 목록 생성

          fileIndex++; // 파일 번호 증가
        }
      }
    } else {
        alert("ERROR");
    }
  }

  // 업로드 파일 목록 생성
  function addFileList(fIndex, fileName, fileSizeStr) {
    /* if (fileSize.match("^0")) {
        alert("start 0");
    } */
    var html = "";
    html += "<tr id='fileTr_" + fIndex + "'>";
    html += "    <td id='dropZone' class='left' >";
    html += fileName + " (" + fileSizeStr +") " 
            //+ "<a href='#' onclick='deleteFile(" + fIndex + "); return false;' class='btn small bg_02'> 삭제</a>"
            
            + "<input value='삭제' type='button' href='#' onclick='deleteFile(" + fIndex + "); return false;'>"
    html += "    </td>"
    html += "</tr>"

    $('#fileTableTbody').append(html);
  }

  // 업로드 파일 삭제
  function deleteFile(fIndex) {
    console.log("deleteFile.fIndex=" + fIndex);
    
    totalFileSize -= fileSizeList[fIndex]; // 전체 파일 사이즈 수정   
    delete fileList[fIndex]; // 파일 배열에서 삭제
    delete fileSizeList[fIndex]; // 파일 사이즈 배열 삭제
    $("#fileTr_" + fIndex).remove(); // 업로드 파일 테이블 목록에서 삭제
    
    console.log("totalFileSize="+totalFileSize);
    
    if (totalFileSize > 0) {
        $("#fileDragDesc").hide(); 
        $("fileListTable").show();
    } else {
        $("#fileDragDesc").show(); 
        $("fileListTable").hide();
    }
  }

  // 파일 등록
  function uploadFile() {
    var uploadFileList = Object.keys(fileList); // 등록할 파일 리스트

    // 파일이 있는지 체크
    if (uploadFileList.length == 0) {
      alert("파일이 없습니다."); // 파일등록 경고창
      return;
    }

    // 용량을 10MB를 넘을 경우 업로드 불가
    if (totalFileSize > maxUploadSize) {
      // 파일 사이즈 초과 경고창
      alert("총 용량 초과\n총 업로드 가능 용량 : " + maxUploadSize + " MB");
      return;
    }

    if (confirm("등록 하시겠습니까?")) {
      // 등록할 파일 리스트를 formData로 데이터 입력
      var form = $('#uploadForm');
      var formData = new FormData(form);
      for (var i = 0; i < uploadFileList.length; i++) {
          formData.append('files', fileList[uploadFileList[i]]);
      }

      $.ajax({
        url : "업로드 경로",
        data : formData,
        type : 'POST',
        enctype : 'multipart/form-data',
        processData : false,
        contentType : false,
        dataType : 'json',
        cache : false,
        success : function(result) {
          if (result.data.length > 0) {
              alert("성공");
              location.reload();
          } else {
              alert("실패");
              location.reload();
          }
        }
      });
    }
  }
  //uplaoad button 
  $('#uploadForm').on('click', function() {
    $('#input_file').trigger('click');
  });
  //datepicker
  $( function(){
    $("#datePicker").datepicker({
      inline: true,
      showOtherMonths: true,
      showMonthAfterYear: true,
      monthNames: [ '01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12' ],
      dayNamesMin: ['일', '월', '화', '수', '목', '금', '토']
    });
  });

  //showPage
  function showUpload(){
    document.getElementById("uploadPage").style.display ='block';
    document.getElementById("detailPage").style.display ='none';
  }
  function showDetail(){
    document.getElementById("detailPage").style.display ='block';
    document.getElementById("uploadPage").style.display ='none';
  }
</script>
</html>